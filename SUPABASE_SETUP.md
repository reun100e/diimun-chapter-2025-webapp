# DIIMUN 2025: Supabase Backend Setup Documentation

This document provides a complete guide to setting up the Supabase backend for the DIIMUN 2025 registration web application. It is designed for future developers or for referencing the project's architecture.

## Table of Contents
1.  [Overview](#overview)
2.  [Prerequisites](#prerequisites)
3.  [Part 1: The Master Database Migration](#part-1-the-master-database-migration)
4.  [Part 2: Storage Setup](#part-2-storage-setup)
5.  [Part 3: Environment Variables & Secrets](#part-3-environment-variables--secrets)
6.  [Part 4: Edge Functions Setup](#part-4-edge-functions-setup)
7.  [Part 5: Deployment & Webhook Connection](#part-5-deployment--webhook-connection)
8.  [Summary of the Automated Workflow](#summary-of-the-automated-workflow)

## Overview

This Supabase backend is designed to be a robust, serverless solution for the event's registration process. Its key features are:

*   **Real-time Partial Saves:** Captures user data as they type to reduce form abandonment.
*   **Intelligent Lead Abandonment:** An automated cron job identifies users who have genuinely abandoned the form (after a 1-hour delay) and notifies the team.
*   **Automated Telegram Notifications:** Sends instant, detailed notifications to a private Telegram group for both completed registrations and abandoned leads.
*   **Dynamic Image Handling:** Correctly processes single or dual (for Esperanza offer) payment screenshots.
*   **Serverless & Scalable:** Built entirely on Supabase's free tier, capable of handling thousands of registrations.

---

## Prerequisites

Before starting, ensure you have the following:

1.  **A Supabase Project:** A new, clean Supabase project is recommended.
2.  **Supabase CLI:** Installed and authenticated. [Installation Guide](https://supabase.com/docs/guides/cli).
3.  **Telegram Bot Details:**
    *   A Telegram Bot Token obtained from `@BotFather`.
    *   The Group Chat ID for your private notifications channel.

---

## Part 1: The Master Database Migration

This single SQL script is the only thing required to set up the entire database schema, including the registrations table, automated triggers, and the intelligent cron job.

**Action:** Navigate to the **SQL Editor** in your Supabase dashboard, paste the entire script below, and click **"RUN"**.

```sql
-- ========= DIIMUN 2025: FINAL & COMPLETE DATABASE MIGRATION (v5) =========

-- ========= SECTION 1: CREATE THE REGISTRATIONS TABLE =========
-- The definitive schema, perfectly aligned with the final React form.

CREATE TABLE public.registrations (
  -- Core Columns
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  
  -- User Information
  name text,
  email text UNIQUE NOT NULL, -- UNIQUE is essential for the partial-save 'upsert' to work
  whatsapp_number text,
  college text,
  year text,
  committee_preference text, -- Stores the final role: WHO, Assembly, IP - Photography, or IP - Essay
  
  -- Registration & Payment Details
  has_registered_esperanza text, -- 'yes' or 'no'
  registration_amount numeric,   -- Stores the final amount paid (499 or 347)
  
  -- Payment Screenshot URLs
  mun_payment_photo_url text,
  esperanza_payment_photo_url text,
  
  -- Internal Status Tracking
  status text NOT NULL DEFAULT 'Partial'::text -- Defaults to 'Partial' for our abandonment feature
);


-- ========= SECTION 2: AUTOMATE THE `updated_at` TIMESTAMP =========
-- This trigger automatically updates `updated_at` on any change, which is key for our abandonment logic.

CREATE OR REPLACE FUNCTION public.handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = timezone('utc'::text, now());
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER on_registration_update
  BEFORE UPDATE ON public.registrations
  FOR EACH ROW
  EXECUTE PROCEDURE public.handle_updated_at();


-- ========= SECTION 3: ENABLE AND CONFIGURE THE CRON JOB =========
-- This sets up an automated job to find and tag abandoned leads.

-- 3.1: Enable the pg_cron extension
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- 3.2: Create the function that finds and marks abandoned leads
CREATE OR REPLACE FUNCTION public.mark_abandoned_leads()
RETURNS void AS $$
  UPDATE public.registrations
  SET status = 'Abandoned'
  WHERE 
    status = 'Partial' AND 
    updated_at < (now() - interval '1 hour');
$$ LANGUAGE sql;

-- 3.3: Schedule the job to run every 15 minutes
SELECT cron.schedule(
  '15-minute-abandoned-lead-check',
  '*/15 * * * *', -- Cron syntax for "at minutes 0, 15, 30, and 45 of every hour"
  'SELECT public.mark_abandoned_leads()'
);


-- ========= SECTION 4: SET UP SECURITY POLICIES =========
-- 4.1: Disable Row Level Security (RLS) on the table
ALTER TABLE public.registrations DISABLE ROW LEVEL SECURITY;

-- 4.2: Create the Storage Policy for anonymous uploads
-- NOTE: You must manually create a bucket named 'payment-screenshots'.
CREATE POLICY "Allow anonymous uploads to payment screenshots"
ON storage.objects FOR INSERT
TO anon
WITH CHECK ( bucket_id = 'payment-screenshots' );

-- ======================= END OF SCRIPT =======================
```

---

## Part 2: Storage Setup

The database script creates a *policy* for storage, but you must create the bucket itself manually.

1.  Navigate to **Storage** in your Supabase dashboard.
2.  Click **"Create a new bucket"**.
3.  Enter the exact bucket name: `payment-screenshots`
4.  Toggle the **"Public bucket"** option to **ON**.
5.  Click **"Create bucket"**.

---

## Part 3: Environment Variables & Secrets

### For the Frontend (React App)

In your React project's root, create a `.env` file and add your Supabase project's **publishable** key.

```
# .env
REACT_APP_SUPABASE_URL=https://your-project-ref.supabase.co
REACT_APP_SUPABASE_ANON_KEY=sb_publishable_...
```

### For the Backend (Edge Functions)

Run these commands in your project's terminal to securely set the secrets for your Telegram bot. These will be available to all Edge Functions.

```bash
supabase secrets set TELEGRAM_BOT_TOKEN=YOUR_TELEGRAM_BOT_TOKEN_HERE
supabase secrets set TELEGRAM_CHAT_ID=YOUR_GROUP_CHAT_ID_HERE
```

---

## Part 4: Edge Functions Setup

This project uses two separate Edge Functions for clean, modular logic.

### 1. Create the Function Directories

In your project's terminal, run these commands:

```bash
supabase functions new completed-registration-notifier
supabase functions new abandoned-lead-notifier
```

### 2. Add the Function Code

#### Function A: `completed-registration-notifier`
*   **Purpose:** Handles fully completed forms, including logic for dual photos and clear role identification.
*   **File Path:** `supabase/functions/completed-registration-notifier/index.ts`

```typescript
// (Paste the complete code from the previous response here)
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const TELEGRAM_BOT_TOKEN = Deno.env.get("TELEGRAM_BOT_TOKEN");
const CHAT_ID = Deno.env.get("TELEGRAM_CHAT_ID");

serve(async (req) => {
  // ... full function code ...
});
```

#### Function B: `abandoned-lead-notifier`
*   **Purpose:** Sends the intelligent, time-delayed notification for genuinely abandoned leads.
*   **File Path:** `supabase/functions/abandoned-lead-notifier/index.ts`

```typescript
// (Paste the complete code from the previous response here)
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const TELEGRAM_BOT_TOKEN = Deno.env.get("TELEGRAM_BOT_TOKEN");
const CHAT_ID = Deno.env.get("TELEGRAM_CHAT_ID");

serve(async (req) => {
  // ... full function code ...
});
```

---

## Part 5: Deployment & Webhook Connection

This is the final step to bring the system online.

### 1. Deploy Both Functions

In your terminal, run these commands:

```bash
supabase functions deploy completed-registration-notifier --no-verify-jwt
supabase functions deploy abandoned-lead-notifier --no-verify-jwt
```

### 2. Get Function URLs

1.  Navigate to **Edge Functions** (`</>`) in your Supabase dashboard.
2.  Click on `completed-registration-notifier` and copy its **Endpoint URL**.
3.  Click on `abandoned-lead-notifier` and copy its **Endpoint URL**.

### 3. Create the Webhooks

Navigate to **Database > Webhooks** and create two webhooks:

#### Webhook 1: For Completed Registrations
*   **Name:** `Send Completion to Telegram`
*   **Table:** `registrations`
*   **Events:** Check **`UPDATE`** only.
*   **HTTP URL:** Paste the URL for the **`completed-registration-notifier`** function.
*   **Click "Create webhook"**.

#### Webhook 2: For Abandoned Leads
*   **Name:** `Send Abandoned Lead to Telegram`
*   **Table:** `registrations`
*   **Events:** Check **`UPDATE`** only.
*   **HTTP URL:** Paste the URL for the **`abandoned-lead-notifier`** function.
*   **Click "Create webhook"**.

---

## Summary of the Automated Workflow

1.  **Partial Lead:** A user starts typing. Their data is saved via `upsert` with `status = 'Partial'`. No notifications are sent.
2.  **Abandoned Lead:**
    *   The cron job runs every 15 minutes.
    *   It finds any `Partial` record last updated over 1 hour ago and changes its `status` to `Abandoned`.
    *   This `UPDATE` triggers the **"Abandoned Lead" webhook**, which runs the `abandoned-lead-notifier` function and sends a clean alert to Telegram.
3.  **Completed Registration:**
    *   A user finishes the form and clicks "Submit".
    *   The form logic `UPDATE`s their record, setting `status = 'Completed'`.
    *   This `UPDATE` triggers the **"Completion" webhook**, which runs the `completed-registration-notifier` function and sends a detailed notification with payment screenshots to Telegram.